// main.dart
import 'dart:async';
import 'package:flutter/material.dart';

// ---------------------------
// Models
// ---------------------------
class FoodItem {
  final String emoji;
  final String name;
  final int price;
  final String description;

  const FoodItem({
    required this.emoji,
    required this.name,
    required this.price,
    required this.description,
  });
}

class CartItem {
  final FoodItem item;
  int quantity;
  CartItem({required this.item, this.quantity = 1});
}

// ---------------------------
// Global state using ValueNotifiers (simple)
 // cartNotifier holds list of CartItem
// themeModeNotifier toggles light/dark
// ---------------------------
final ValueNotifier<List<CartItem>> cartNotifier = ValueNotifier([]);
final ValueNotifier<ThemeMode> themeModeNotifier =
    ValueNotifier(ThemeMode.light);

// Helper to add item to cart
void addToCart(FoodItem item) {
  final list = cartNotifier.value;
  final existing = list.indexWhere((ci) => ci.item.name == item.name);
  if (existing >= 0) {
    list[existing].quantity += 1;
  } else {
    list.add(CartItem(item: item, quantity: 1));
  }
  cartNotifier.value = List.from(list);
}

// Helper to remove one quantity or delete
void removeFromCart(FoodItem item) {
  final list = cartNotifier.value;
  final existing = list.indexWhere((ci) => ci.item.name == item.name);
  if (existing >= 0) {
    if (list[existing].quantity > 1) {
      list[existing].quantity -= 1;
    } else {
      list.removeAt(existing);
    }
  }
  cartNotifier.value = List.from(list);
}

void deleteCartItem(FoodItem item) {
  final list = cartNotifier.value.where((ci) => ci.item.name != item.name).toList();
  cartNotifier.value = List.from(list);
}

void clearCart() {
  cartNotifier.value = [];
}

// ---------------------------
// Sample food items (15+)
// ---------------------------
const List<FoodItem> sampleFood = [
  FoodItem(
    emoji: 'üçï',
    name: 'Pizza',
    price: 199,
    description: 'Classic cheese pizza with fresh tomato sauce.',
  ),
  FoodItem(
    emoji: 'üçî',
    name: 'Burger',
    price: 149,
    description: 'Juicy veg/egg burger with crispy patties.',
  ),
  FoodItem(
    emoji: 'üç£',
    name: 'Sushi',
    price: 299,
    description: 'Assorted sushi rolls with fresh ingredients.',
  ),
  FoodItem(
    emoji: 'üçú',
    name: 'Noodles',
    price: 129,
    description: 'Stir-fried noodles with vegetables and sauce.',
  ),
  FoodItem(
    emoji: 'üç∞',
    name: 'Cake',
    price: 199,
    description: 'Soft and creamy layered cake slice.',
  ),
  FoodItem(
    emoji: 'üåØ',
    name: 'Burrito',
    price: 179,
    description: 'Loaded burrito with beans, rice and veggies.',
  ),
  FoodItem(
    emoji: 'üåÆ',
    name: 'Taco',
    price: 159,
    description: 'Crispy taco filled with seasoned fillings.',
  ),
  FoodItem(
    emoji: 'ü•ó',
    name: 'Salad',
    price: 99,
    description: 'Fresh garden salad with house dressing.',
  ),
  FoodItem(
    emoji: 'üçü',
    name: 'Fries',
    price: 89,
    description: 'Crispy golden fries with ketchup.',
  ),
  FoodItem(
    emoji: 'üçù',
    name: 'Pasta',
    price: 149,
    description: 'Creamy pasta tossed with herbs.',
  ),
  FoodItem(
    emoji: 'üç©',
    name: 'Donut',
    price: 79,
    description: 'Sweet glazed donut, freshly baked.',
  ),
  FoodItem(
    emoji: 'üçõ',
    name: 'Biryani',
    price: 229,
    description: 'Aromatic biryani with spices and herbs.',
  ),
  FoodItem(
    emoji: 'üßã',
    name: 'Bubble Tea',
    price: 119,
    description: 'Refreshing milk tea with tapioca pearls.',
  ),
  FoodItem(
    emoji: 'üçó',
    name: 'Fried Chicken',
    price: 189,
    description: 'Crispy fried chicken with special coating.',
  ),
  FoodItem(
    emoji: 'üç¶',
    name: 'Ice Cream',
    price: 99,
    description: 'Cold creamy ice cream scoop.',
  ),
  // a couple extras
  FoodItem(
    emoji: 'ü•™',
    name: 'Sandwich',
    price: 129,
    description: 'Toasted sandwich with veggies and cheese.',
  ),
  FoodItem(
    emoji: 'üßÄ',
    name: 'Cheese Sticks',
    price: 109,
    description: 'Melty cheese sticks with dip.',
  ),
];

// ---------------------------
// Main
// ---------------------------
void main() {
  runApp(const DeliverEatsApp());
}

class DeliverEatsApp extends StatefulWidget {
  const DeliverEatsApp({Key? key}) : super(key: key);

  @override
  State<DeliverEatsApp> createState() => _DeliverEatsAppState();
}

class _DeliverEatsAppState extends State<DeliverEatsApp> {
  @override
  void initState() {
    super.initState();
    themeModeNotifier.addListener(_themeListener);
  }

  void _themeListener() {
    setState(() {});
  }

  @override
  void dispose() {
    themeModeNotifier.removeListener(_themeListener);
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return ValueListenableBuilder<ThemeMode>(
      valueListenable: themeModeNotifier,
      builder: (context, mode, _) {
        return MaterialApp(
          debugShowCheckedModeBanner: false,
          title: 'DeliverEats',
          themeMode: mode,
          theme: ThemeData(
            brightness: Brightness.light,
            primarySwatch: Colors.deepOrange,
            useMaterial3: true,
          ),
          darkTheme: ThemeData(
            brightness: Brightness.dark,
            primarySwatch: Colors.deepOrange,
            useMaterial3: true,
          ),
          home: const SplashScreen(),
        );
      },
    );
  }
}

// ---------------------------
// Splash Screen with scooter animation + fade
// Auto-navigate to Login after 3 seconds
// ---------------------------
class SplashScreen extends StatefulWidget {
  const SplashScreen({Key? key}) : super(key: key);
  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen>
    with SingleTickerProviderStateMixin {
  late final AnimationController _controller;
  late final Animation<double> _scooterAnim;
  late final Animation<double> _fadeAnim;

  @override
  void initState() {
    super.initState();

    _controller =
        AnimationController(vsync: this, duration: const Duration(seconds: 3));
    _scooterAnim = Tween<double>(begin: -0.4, end: 1.2).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeInOut),
    );
    _fadeAnim = Tween<double>(begin: 0, end: 1).animate(
      CurvedAnimation(parent: _controller, curve: const Interval(0.0, 0.8)),
    );

    _controller.forward();

    // Navigate after 3 seconds
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        Navigator.of(context).pushReplacement(
          MaterialPageRoute(builder: (_) => const LoginScreen()),
        );
      }
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  Widget _buildScooter(double screenWidth) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        final leftPercent = _scooterAnim.value;
        final dx = leftPercent * screenWidth;
        return Positioned(
          left: dx,
          bottom: 60,
          child: Opacity(
            opacity: 0.98,
            child: Row(
              children: [
                Text(
                  'üõµ',
                  style: const TextStyle(fontSize: 52),
                ),
                // smoke effect as small emojis that fade
                Transform.translate(
                  offset: Offset(-18, -30),
                  child: Opacity(
                    opacity: 1.0 - (_controller.value.clamp(0.0, 1.0)),
                    child: const Text('üí®', style: TextStyle(fontSize: 18)),
                  ),
                )
              ],
            ),
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    return Scaffold(
      body: Stack(
        children: [
          // background gradient
          AnimatedBuilder(
            animation: _fadeAnim,
            builder: (context, child) {
              return Opacity(
                opacity: _fadeAnim.value,
                child: Container(
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        Colors.deepOrange.shade300,
                        Colors.deepOrange.shade700,
                      ],
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                    ),
                  ),
                ),
              );
            },
          ),
          // Branding center
          Center(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Text(
                  'DeliverEats',
                  style: TextStyle(
                    fontSize: 36,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                    letterSpacing: 1.2,
                  ),
                ),
                const SizedBox(height: 8),
                Opacity(
                  opacity: _fadeAnim.value,
                  child: const Text(
                    'Fast ‚Ä¢ Fresh ‚Ä¢ Friendly',
                    style: TextStyle(
                        fontSize: 16,
                        color: Colors.white70,
                        fontWeight: FontWeight.w500),
                  ),
                ),
                const SizedBox(height: 24),
                Opacity(
                  opacity: _fadeAnim.value,
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: const [
                      Text('Enjoy your meal ', style: TextStyle(color: Colors.white70)),
                      Text('üçΩÔ∏è', style: TextStyle(fontSize: 22)),
                    ],
                  ),
                ),
              ],
            ),
          ),
          // Scooter animated across bottom
          Positioned.fill(
            child: Stack(
              children: [
                _buildScooter(screenWidth),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// ---------------------------
// Login Screen
// ---------------------------
class LoginScreen extends StatefulWidget {
  const LoginScreen({Key? key}) : super(key: key);
  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _usernameCtl = TextEditingController();
  final _passwordCtl = TextEditingController();
  final _formKey = GlobalKey<FormState>();
  bool _obscure = true;

  @override
  void dispose() {
    _usernameCtl.dispose();
    _passwordCtl.dispose();
    super.dispose();
  }

  void _login() {
    if (_formKey.currentState!.validate()) {
      // simulate successful login -> go to MainHome
      Navigator.of(context).pushReplacement(
        MaterialPageRoute(builder: (_) => const MainHome()),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Login'),
        centerTitle: true,
      ),
      body: Padding(
        padding: const EdgeInsets.all(18.0),
        child: Center(
          child: SingleChildScrollView(
            child: Form(
              key: _formKey,
              child: Column(
                children: [
                  const Text('Welcome to DeliverEats', style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                  const SizedBox(height: 12),
                  TextFormField(
                    controller: _usernameCtl,
                    decoration: const InputDecoration(
                      labelText: 'Username',
                      prefixIcon: Icon(Icons.person),
                      border: OutlineInputBorder(),
                    ),
                    validator: (v) => (v == null || v.trim().isEmpty) ? 'Please enter username' : null,
                  ),
                  const SizedBox(height: 12),
                  TextFormField(
                    controller: _passwordCtl,
                    obscureText: _obscure,
                    decoration: InputDecoration(
                      labelText: 'Password',
                      prefixIcon: const Icon(Icons.lock),
                      border: const OutlineInputBorder(),
                      suffixIcon: IconButton(
                        icon: Icon(_obscure ? Icons.visibility_off : Icons.visibility),
                        onPressed: () => setState(() => _obscure = !_obscure),
                      ),
                    ),
                    validator: (v) => (v == null || v.trim().isEmpty) ? 'Please enter password' : null,
                  ),
                  const SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: _login,
                    child: const Padding(
                      padding: EdgeInsets.symmetric(horizontal: 24.0, vertical: 12),
                      child: Text('Login', style: TextStyle(fontSize: 16)),
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextButton(
                    onPressed: () {
                      final snack = SnackBar(content: Text('Sign Up (demo) tapped ‚Äî sign up is simulated.'));
                      ScaffoldMessenger.of(context).showSnackBar(snack);
                    },
                    child: const Text('Sign Up (demo)'),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// ---------------------------
// Main Home with BottomNavigationBar and 5 tabs
// ---------------------------
class MainHome extends StatefulWidget {
  const MainHome({Key? key}) : super(key: key);
  @override
  State<MainHome> createState() => _MainHomeState();
}

class _MainHomeState extends State<MainHome> {
  int _selectedIndex = 0;

  static const List<Widget> _tabsPlaceholder = [
    SizedBox(),
    SizedBox(),
    SizedBox(),
    SizedBox(),
    SizedBox(),
  ];

  @override
  Widget build(BuildContext context) {
    Widget body;
    switch (_selectedIndex) {
      case 0:
        body = HomeTab(onOpenDetails: _openDetails);
        break;
      case 1:
        body = const OffersTab();
        break;
      case 2:
        body = CartTab(onProceedToPayment: _openPayment);
        break;
      case 3:
        body = ProfileTab();
        break;
      case 4:
        body = SettingsTab(onLogout: _logout);
        break;
      default:
        body = _tabsPlaceholder[_selectedIndex];
    }

    return Scaffold(
      appBar: AppBar(
        title: const Text('DeliverEats'),
        actions: [
          IconButton(
            onPressed: () {
              // quick cart open
              setState(() {
                _selectedIndex = 2;
              });
            },
            icon: const Icon(Icons.shopping_cart),
          ),
        ],
      ),
      body: SafeArea(child: body),
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: _selectedIndex,
        onTap: (i) => setState(() => _selectedIndex = i),
        type: BottomNavigationBarType.fixed,
        items: const [
          BottomNavigationBarItem(icon: Text('üçï', style: TextStyle(fontSize: 18)), label: 'Home'),
          BottomNavigationBarItem(icon: Text('üéÅ', style: TextStyle(fontSize: 18)), label: 'Offers'),
          BottomNavigationBarItem(icon: Text('üõí', style: TextStyle(fontSize: 18)), label: 'Cart'),
          BottomNavigationBarItem(icon: Text('üë§', style: TextStyle(fontSize: 18)), label: 'Profile'),
          BottomNavigationBarItem(icon: Text('‚öôÔ∏è', style: TextStyle(fontSize: 18)), label: 'Settings'),
        ],
      ),
    );
  }

  void _openDetails(FoodItem item) {
    Navigator.of(context).push(
      MaterialPageRoute(builder: (_) => DetailScreen(foodItem: item)),
    );
  }

  void _openPayment() {
    Navigator.of(context).push(
      MaterialPageRoute(builder: (_) => const PaymentScreen()),
    );
  }

  void _logout() {
    // clear cart, navigate to splash -> login
    clearCart();
    Navigator.of(context).pushAndRemoveUntil(
      MaterialPageRoute(builder: (_) => const SplashScreen()),
      (route) => false,
    );
  }
}

// ---------------------------
// Home Tab (grid of foods)
// ---------------------------
class HomeTab extends StatelessWidget {
  final void Function(FoodItem) onOpenDetails;
  const HomeTab({Key? key, required this.onOpenDetails}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final items = sampleFood;
    return Padding(
      padding: const EdgeInsets.all(8.0),
      child: GridView.builder(
        itemCount: items.length,
        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: 2, childAspectRatio: 0.9, crossAxisSpacing: 8, mainAxisSpacing: 8,
        ),
        itemBuilder: (context, index) {
          final f = items[index];
          return Card(
            elevation: 3,
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            child: InkWell(
              borderRadius: BorderRadius.circular(12),
              onTap: () => onOpenDetails(f),
              child: Padding(
                padding: const EdgeInsets.all(10.0),
                child: Column(
                  children: [
                    Text(f.emoji, style: const TextStyle(fontSize: 36)),
                    const SizedBox(height: 8),
                    Text(f.name, style: const TextStyle(fontWeight: FontWeight.bold)),
                    const Spacer(),
                    Text('‚Çπ${f.price}', style: const TextStyle(fontSize: 16)),
                    const SizedBox(height: 8),
                    ElevatedButton(
                      onPressed: () => onOpenDetails(f),
                      child: const Text('Details'),
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}

// ---------------------------
// Offers Tab (simple list of discount strings)
// ---------------------------
class OffersTab extends StatelessWidget {
  const OffersTab({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final offers = [
      '10% off on orders above ‚Çπ499',
      'Free delivery for first 3 orders',
      'Buy 1 Get 1 Donut every Tuesday',
      '20% off on Pizza combo',
      'Flat ‚Çπ50 off for new users',
    ];
    return ListView.separated(
      padding: const EdgeInsets.all(12),
      itemBuilder: (context, index) {
        return ListTile(
          leading: const Icon(Icons.local_offer),
          title: Text(offers[index]),
          trailing: const Text('Apply'),
        );
      },
      separatorBuilder: (_, __) => const Divider(),
      itemCount: offers.length,
    );
  }
}

// ---------------------------
// Detail Screen
// ---------------------------
class DetailScreen extends StatelessWidget {
  final FoodItem foodItem;
  const DetailScreen({Key? key, required this.foodItem}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final item = foodItem;
    return Scaffold(
      appBar: AppBar(title: Text(item.name)),
      body: Padding(
        padding: const EdgeInsets.all(18.0),
        child: Column(
          children: [
            Text(item.emoji, style: const TextStyle(fontSize: 72)),
            const SizedBox(height: 12),
            Text(item.name, style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            Text('Price: ‚Çπ${item.price}', style: const TextStyle(fontSize: 18)),
            const SizedBox(height: 12),
            Text(item.description, style: const TextStyle(fontSize: 16)),
            const Spacer(),
            ElevatedButton.icon(
           
